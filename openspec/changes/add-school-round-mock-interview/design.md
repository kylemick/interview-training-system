# Design: 学校-轮次模拟面试练习模式

## Context

香港升中面试通常分为多个轮次，不同轮次的考查重点和题目风格可能不同。例如：
- 第一轮：初步筛选，可能更注重基本能力和语言表达
- 第二轮：深入评估，可能更注重逻辑思维和批判性思考
- 最终轮：综合评估，可能包含小组讨论等

学生希望能够针对特定学校的特定轮次进行针对性练习，系统需要：
1. 存储和管理面试轮次信息
2. 根据学校和轮次搜索相关题目和面试回忆
3. 基于历史数据生成类似风格的模拟题目
4. 提供完整的模拟面试体验

## Goals / Non-Goals

### Goals
- 支持选择学校和面试轮次进行模拟面试
- 基于该学校对应轮次的历史题目生成类似题目
- 在生成题目时能够搜索和参考学校轮次相关信息
- 提供完整的模拟面试流程，覆盖该轮次常见考查重点
- 保持与现有练习模式的兼容性

### Non-Goals
- 不强制要求所有面试回忆都必须有轮次信息（向后兼容）
- 不在本阶段实现多轮次面试的完整流程模拟（如第一轮通过后才能进入第二轮）
- 不实现面试官角色扮演的实时对话（已有AI模拟面试模式，但本功能专注于题目生成）

## Decisions

### Decision 1: 轮次信息存储方式

**方案A**: 在`interview_memories`表中增加`interview_round`字段
- 优点：简单直接，与现有数据结构一致
- 缺点：如果未来需要更复杂的轮次信息（如轮次描述、考查重点等），可能需要扩展

**方案B**: 创建独立的`interview_rounds`表，关联到`interview_memories`
- 优点：更灵活，可以存储更多轮次相关信息
- 缺点：增加复杂度，当前需求可能不需要

**选择**: 方案A。当前需求主要是根据轮次筛选和生成题目，在`interview_memories`表中增加可选字段即可满足需求。如果未来需要更复杂的轮次管理，可以再扩展。

### Decision 2: 轮次值的定义

**方案A**: 使用数字（"1", "2", "3"等）
- 优点：简单直观
- 缺点：不同学校的轮次含义可能不同

**方案B**: 使用描述性字符串（"first-round", "second-round", "final-round"等）
- 优点：更清晰，可以包含更多信息
- 缺点：需要标准化，可能不够灵活

**方案C**: 使用中文描述（"第一轮", "第二轮", "最终轮"等）
- 优点：符合用户习惯
- 缺点：需要标准化，可能不够灵活

**选择**: 方案B + 方案C结合。系统内部使用标准化英文值（"first-round", "second-round", "final-round"），前端显示使用中文。同时支持用户自定义轮次描述（如"SPCC第一轮"），存储在`interview_round`字段中。

### Decision 3: 题目生成策略

**方案A**: 仅从题库中选择该学校该轮次的现有题目
- 优点：简单，题目质量有保证
- 缺点：如果题目数量不足，可能无法完成完整模拟

**方案B**: 优先选择现有题目，不足时AI生成类似题目
- 优点：保证题目数量，同时保持题目风格一致
- 缺点：需要AI生成逻辑，可能增加成本

**方案C**: 完全基于AI生成，参考历史题目风格
- 优点：灵活，可以生成任意数量的题目
- 缺点：完全依赖AI，可能风格不一致

**方案D**: 使用AI搜索外部信息，基于真实历史题目生成
- 优点：能够获取该学校真实考过的题目信息，更贴近实际
- 缺点：依赖AI的知识库，可能搜索不到足够信息

**选择**: 方案D（更新）。优先使用AI搜索外部信息（该学校历史考过的真实题目），基于搜索结果生成类似风格的模拟题目。如果外部搜索失败，降级使用数据库中的历史数据。这样能够确保生成的题目更贴近该学校的真实面试情况。

### Decision 4: 题目信息来源和搜索策略

**主要信息来源**：
1. **外部AI搜索**（优先）：使用AI的知识库搜索该学校历史真实考过的面试题目
   - 搜索该学校的历史面试题目
   - 搜索该学校不同轮次的考查重点
   - 搜索该学校的面试风格和特点
2. **数据库历史数据**（降级）：如果外部搜索失败，使用数据库中的历史数据
   - `questions`表中`school_code`匹配的题目
   - `interview_memories`表中`school_code`和`interview_round`匹配的面试回忆

**搜索优先级**：
1. AI外部搜索（获取真实历史题目信息）
2. 数据库中的历史题目和面试回忆（降级方案）
3. 基于学校特征生成（最后方案）

## Risks / Trade-offs

### Risk 1: 轮次数据不足
**风险**: 某些学校或轮次可能没有足够的历史数据
**缓解**: 
- 允许扩展到该学校的其他轮次数据
- 如果仍不足，使用该学校的一般特征生成题目
- 在UI中提示用户数据来源

### Risk 2: 轮次信息不准确
**风险**: 用户录入的轮次信息可能不准确或不一致
**缓解**: 
- 提供标准化的轮次选项（下拉选择）
- 允许用户自定义，但建议使用标准格式
- 在生成题目时，如果数据不足，自动扩展到更宽泛的范围

### Risk 3: AI生成题目风格不一致
**风险**: AI生成的题目可能与真实面试题目风格有差异
**缓解**: 
- 在提示词中明确要求参考历史题目风格
- 提供历史题目作为示例
- 允许用户查看题目来源（历史题目 vs AI生成）

### Trade-off: 数据完整性 vs 功能可用性
- 如果严格要求轮次信息，可能导致功能无法使用（数据不足）
- 如果放宽要求，可能生成的题目不够针对性
- **平衡**: 优先使用精确匹配的数据，但允许降级到更宽泛的范围

## Migration Plan

### 数据库迁移
1. 为`interview_memories`表增加`interview_round`字段（VARCHAR(50)，可选，允许NULL）
2. 增加索引：`INDEX idx_school_round (school_code, interview_round)`（如果MySQL支持）
3. 现有数据：`interview_round`字段为NULL，不影响现有功能

### 代码迁移
1. 更新面试回忆录入界面，增加轮次选择
2. 更新面试回忆分析API，支持提取和保存轮次信息
3. 更新题目生成逻辑，支持基于轮次搜索和生成
4. 更新练习会话创建逻辑，支持学校-轮次模式

### 向后兼容
- 所有现有功能保持兼容
- 如果未选择轮次或轮次信息不存在，降级到学校级别的题目生成
- 不影响现有的任务模式、自由模式和弱点专项练习模式

## Open Questions

1. **轮次标准化**: 是否需要定义标准的轮次列表（如"第一轮"、"第二轮"、"最终轮"），还是完全由用户自定义？
   - **建议**: 提供标准选项，同时允许自定义

2. **题目数量**: 一次模拟面试应该包含多少道题目？
   - **建议**: 可配置，默认10-15题，覆盖该轮次常见考查重点

3. **轮次信息展示**: 在题目生成时，是否需要向用户展示参考了哪些历史题目或面试回忆？
   - **建议**: 在题目详情中显示来源信息，但不在主流程中干扰用户

4. **多轮次支持**: 是否支持一次练习包含多个轮次（如先第一轮，再第二轮）？
   - **建议**: 第一阶段仅支持单轮次，未来可扩展
