# Design: 自动生成题目以避免服务中断

## Context

当前系统在多个场景下需要从题库选择题目：
1. 从训练计划任务启动练习会话（`POST /api/plans/tasks/:taskId/start-practice`）
2. 创建自由模式练习会话（`POST /api/sessions`）

当某个类别没有可用题目时，系统会抛出 `AppError(400, '该类别暂无可用题目,请先添加题目')`，导致流程中断。

## Goals / Non-Goals

### Goals
- 当检测到题目缺失时，自动调用AI生成题目
- 生成的题目数量应该满足当前需求（根据任务时长或指定数量计算）
- 生成的题目应该考虑上下文（类别、目标学校、难度）
- 确保错误处理不会导致服务崩溃或重启
- 保持现有API接口的兼容性

### Non-Goals
- 不改变题目生成API的接口
- 不改变题目数据结构
- 不改变前端交互流程（对用户透明）

## Decisions

### Decision 1: 自动生成题目的触发时机

**选择**：在查询题目返回空结果时立即触发生成

**理由**：
- 时机明确：只有在真正需要题目时才生成，避免浪费
- 用户体验好：用户无需等待，系统自动处理
- 实现简单：在现有查询逻辑后添加生成逻辑即可

**替代方案**：
- 在创建计划时预生成所有类别题目：浪费资源，可能生成不需要的题目
- 前端提示用户手动生成：增加用户操作步骤

### Decision 2: 题目生成数量策略

**选择**：根据实际需求动态计算生成数量

**场景1 - 从任务启动练习**：
- 根据任务时长计算：`Math.max(1, Math.ceil(duration / 10))`，最少1题
- 如果前端指定了 `question_count`，使用前端值
- 生成数量 = `Math.max(calculatedCount, 3)`，至少生成3题以确保有足够选择

**场景2 - 自由模式创建会话**：
- 使用前端指定的 `question_count`，默认10题
- 生成数量 = `Math.max(question_count, 3)`

**理由**：
- 避免频繁生成：一次生成足够数量，减少AI调用
- 保证可用性：至少生成3题，确保后续选择有缓冲

### Decision 3: 题目生成参数

**选择**：根据上下文智能设置生成参数

- **category**: 从任务或请求中获取
- **difficulty**: 默认使用 `medium`，后续可以根据学生表现调整
- **count**: 根据上述策略计算
- **school_code**: 从训练计划或任务关联的计划中获取目标学校
- **save**: 始终为 `true`，保存到数据库

**理由**：
- 使用中等难度作为默认值，适合大多数学生
- 保存题目到数据库，避免重复生成
- 考虑目标学校，生成更有针对性的题目

### Decision 4: AI生成失败的处理

**选择**：多层降级策略

1. **第一层**：如果AI生成失败，记录错误日志，但不抛出异常
2. **第二层**：尝试使用更简单的参数重新生成（减少数量、不指定学校）
3. **第三层**：如果仍然失败，返回友好的错误信息，但不导致服务崩溃

**理由**：
- 确保服务稳定性：即使AI失败，也不应该导致整个服务崩溃
- 提供降级方案：尝试简化参数可能成功
- 用户友好：清晰的错误信息帮助用户理解问题

### Decision 5: 错误处理增强

**选择**：在所有可能抛出题目缺失错误的地方，改为自动生成

**需要修改的位置**：
1. `backend/src/routes/plans.ts:738` - 现有会话中题目被删除的情况
2. `backend/src/routes/plans.ts:784` - 新会话创建时没有题目
3. `backend/src/routes/sessions.ts:41` - 自由模式创建会话时没有题目

**理由**：
- 统一处理：所有场景都使用相同的自动生成逻辑
- 减少代码重复：提取为公共函数
- 确保完整性：不遗漏任何可能的问题点

## Risks / Trade-offs

### Risk 1: AI生成延迟影响用户体验
**风险**：AI生成题目可能需要几秒钟，用户需要等待
**缓解**：
- 显示加载提示（前端已有loading状态）
- 异步生成：可以先返回部分结果，后台继续生成
- 考虑缓存：相同参数的题目可以复用

### Risk 2: AI生成成本增加
**风险**：频繁自动生成可能增加API调用成本
**缓解**：
- 生成的题目保存到数据库，避免重复生成
- 生成数量合理控制，不过度生成
- 优先使用现有题目，只在必要时生成

### Risk 3: 生成的题目质量不一致
**风险**：自动生成的题目可能质量参差不齐
**缓解**：
- 使用现有的AI生成逻辑，已经过验证
- 生成的题目可以后续人工审核和优化
- 系统会记录题目来源，便于追踪

## Migration Plan

### 步骤1：创建题目自动生成辅助函数
- 在 `backend/src/routes/plans.ts` 或新建工具文件
- 函数签名：`async function ensureQuestionsAvailable(category, count, schoolCode?, difficulty?)`
- 逻辑：查询题目 → 如果不足则生成 → 返回题目列表

### 步骤2：修改训练计划任务启动逻辑
- 在 `POST /api/plans/tasks/:taskId/start-practice` 中
- 替换抛出错误为调用 `ensureQuestionsAvailable`
- 处理AI生成失败的情况

### 步骤3：修改自由模式会话创建逻辑
- 在 `POST /api/sessions` 中
- 替换抛出错误为调用 `ensureQuestionsAvailable`
- 处理AI生成失败的情况

### 步骤4：增强错误处理
- 确保所有错误都被正确捕获
- 验证错误处理不会导致服务重启
- 添加适当的日志记录

### 步骤5：测试验证
- 测试题目缺失场景
- 测试AI生成失败场景
- 测试正常流程不受影响

## Open Questions

1. **题目生成数量**：是否应该生成更多题目作为缓冲？当前策略是至少生成3题，是否足够？
   - **决定**：至少生成所需数量+2题作为缓冲，但不超过10题

2. **难度选择**：是否应该根据学生历史表现动态选择难度？
   - **决定**：当前使用 `medium` 作为默认值，后续可以增强

3. **生成频率限制**：是否应该限制同一类别的生成频率？
   - **决定**：暂不限制，因为题目会保存到数据库，重复生成的情况较少
