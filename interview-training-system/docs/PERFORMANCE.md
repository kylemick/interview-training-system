# 性能优化文档

## 性能目标

### 前端性能

- **页面首次加载时间**：< 1 秒（本地环境）
- **页面刷新**：所有页面刷新后能正常加载数据
- **交互响应时间**：< 100ms

### 后端性能

- **API 响应时间**：
  - 简单查询（单表查询）：< 500ms
  - 复杂查询（多表 JOIN、统计）：< 2 秒
- **数据库查询**：
  - 慢查询阈值：100ms
  - 所有超过阈值的查询都会记录日志

## 已实施的优化

### 前端优化

1. **API 请求优化**
   - ✅ 并行请求：使用 `Promise.all` 并行加载数据
   - ✅ 请求去重：相同请求在 pending 时不重复发送
   - ✅ 请求缓存：GET 请求缓存 5 分钟
   - ✅ 请求取消：组件卸载时自动取消未完成的请求
   - ✅ 超时设置：API 超时从 30 秒降低到 10 秒

2. **React 性能优化**
   - ✅ 使用 `useMemo` 缓存计算结果
   - ✅ 使用 `useCallback` 缓存回调函数
   - ✅ 使用 `React.memo` 优化列表组件（如需要）
   - ✅ 优化 columns 定义，避免每次渲染重新创建

3. **页面优化**
   - ✅ Dashboard 页面：并行加载任务、会话、弱点数据
   - ✅ Questions 页面：并行加载题目、统计、学校列表

### 后端优化

1. **数据库查询优化**
   - ✅ 查询性能监控：记录超过 100ms 的慢查询
   - ✅ 查询结果缓存：学校列表、统计信息等使用缓存（5 分钟 TTL）
   - ✅ JSON 字段统一解析：在数据库访问层统一解析，避免重复解析
   - ✅ 数据库索引：已为所有常用查询字段添加索引

2. **路由优化**
   - ✅ 学校列表：使用缓存
   - ✅ 统计查询：使用缓存
   - ✅ JSON 字段解析：统一使用 `parseJsonField` 函数

## 性能监控

### 前端监控

- 使用浏览器开发者工具 Network 面板监控 API 请求时间
- 使用 React DevTools Profiler 分析组件渲染性能

### 后端监控

- 慢查询日志：所有超过 100ms 的查询都会在控制台输出警告
- 查询统计：开发环境下记录所有查询的 SQL 和参数

## 性能测试方法

### 前端性能测试

1. **页面加载时间**
   ```bash
   # 使用浏览器开发者工具
   # 1. 打开 Network 面板
   # 2. 刷新页面
   # 3. 查看 Load 时间（应 < 1 秒）
   ```

2. **API 响应时间**
   ```bash
   # 使用 curl 测试
   curl -w "@curl-format.txt" -o /dev/null -s "http://localhost:3001/api/schools"
   ```

### 后端性能测试

1. **数据库查询性能**
   ```bash
   # 查看慢查询日志（开发环境下自动输出）
   # 所有超过 100ms 的查询都会显示警告
   ```

2. **API 响应时间**
   ```bash
   # 使用 curl 测试
   time curl "http://localhost:3001/api/questions?limit=10"
   ```

## 性能优化建议

### 前端

1. **图片优化**
   - 使用适当的图片格式（WebP、AVIF）
   - 实现图片懒加载

2. **代码分割**
   - 使用 React.lazy 实现路由级别的代码分割
   - 使用动态 import 实现组件级别的代码分割

3. **缓存策略**
   - 静态资源使用长期缓存
   - API 响应使用短期缓存（5 分钟）

### 后端

1. **数据库优化**
   - 定期分析慢查询日志
   - 根据查询模式调整索引
   - 考虑使用物化视图（如需要）

2. **缓存策略**
   - 对频繁访问的数据使用缓存
   - 实现缓存失效策略（数据变更时清除相关缓存）

3. **查询优化**
   - 避免 SELECT *
   - 使用 LIMIT 限制结果数量
   - 避免 N+1 查询问题

## 性能问题排查

### 页面加载慢

1. 检查 Network 面板，找出慢的 API 请求
2. 检查是否有重复请求
3. 检查是否有阻塞渲染的操作

### API 响应慢

1. 查看后端慢查询日志
2. 检查数据库查询是否使用了索引
3. 检查是否有 N+1 查询问题

### 页面刷新失败

1. 检查 API 请求是否成功
2. 检查错误处理是否正确
3. 检查组件状态管理是否正确

## 参考资源

- [Web Performance](https://web.dev/performance/)
- [React Performance](https://react.dev/learn/render-and-commit)
- [MySQL Performance Tuning](https://dev.mysql.com/doc/refman/8.0/en/optimization.html)
