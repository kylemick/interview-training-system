# Change: 计划和练习联动

## Why

当前系统中,训练计划和练习会话是完全独立的两个模块。用户创建了训练计划后,仍然需要手动选择类别和数量来开始练习,无法跟随计划进行系统化训练。这导致:
1. 计划失去了指导作用,用户可能偏离计划随意练习
2. 每日任务的完成状态无法与实际练习会话同步
3. 用户体验不连贯,需要在两个模块之间手动协调
4. 无法追踪用户是否按计划完成训练,影响进度统计和反馈质量

## What Changes

### 核心功能
- 在前端Dashboard和训练计划页面,增加"开始今日任务"入口,直接进入对应的练习会话
- 练习会话与每日任务强关联,创建会话时自动从任务指定的类别选择题目
- 完成练习会话后,自动标记关联的每日任务为已完成
- 在练习页面显示当前任务来源(计划名称、日期、类别、进度)
- 提供"自由练习"模式,允许用户不跟随计划进行额外练习

### 用户体验增强
- 任务完成后智能引导: 提示继续下一个任务或庆祝全部完成
- 任务状态可视化: 清晰展示待开始/进行中/已完成三种状态
- 双模式支持: 任务练习(计划驱动)和自由练习(灵活选择)并存

### 技术实现
- 新增API: `GET /api/plans/pending-tasks` (获取未完成任务)
- 新增API: `POST /api/plans/tasks/:taskId/start-practice` (从任务创建会话)
- 增强API: `PATCH /api/sessions/:id/complete` (自动同步任务状态)
- 数据库: 增强`sessions.task_id`外键关联,添加索引优化查询

**BREAKING**: 练习会话创建逻辑改变,需要检查是否有未完成的计划任务。但保持向后兼容,自由练习模式不受影响。

## Impact

### 影响规范
- **practice-linkage** (新增): 定义任务-会话联动机制和双模式支持

### 影响代码
- **前端**:
  - `Practice/index.tsx`: 支持taskId参数,任务模式自动加载,任务信息横幅显示
  - `Dashboard/index.tsx`: 今日任务卡片,任务进度展示,一键启动练习
  - `TrainingPlan/index.tsx`: 任务状态显示,开始按钮,任务列表优化
- **后端**:
  - `routes/sessions.ts`: 完成会话时自动标记关联任务完成
  - `routes/plans.ts`: 新增pending-tasks和start-practice接口
- **数据库**:
  - `sessions`表: 增强`task_id`外键约束和索引
  - `daily_tasks`表: 添加状态索引优化查询

### 实现状态
- ✅ **已完成**: 核心功能已实现并测试通过
  - 任务驱动的练习入口
  - 会话-任务自动关联和状态同步
  - 双模式支持(任务练习/自由练习)
  - 任务完成后的流程引导
- 🔄 **进行中**: 部分增强功能
  - 任务跳过功能
  - 导航栏任务徽章
  - 统计数据区分
- 📋 **待规划**: 未来优化方向
  - 任务恢复功能(暂停后继续)
  - 任务历史页面
  - 更详细的进度追踪

## Benefits

1. **用户体验提升**: 从"创建计划→手动选择练习"变为"一键开始任务",操作步骤减少60%
2. **数据一致性**: 任务状态与练习会话自动同步,避免手动更新错误
3. **训练效果**: 用户更可能按计划完成训练,提高系统化训练效果
4. **灵活性**: 保留自由练习模式,不强制用户必须创建计划
5. **可扩展性**: 为后续功能(任务恢复、进度分析等)打下基础
