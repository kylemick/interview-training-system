# Design: 學校-輪次模拟面試練習模式

## Context

香港升中面試通常分为多个輪次，不同輪次的考查重點和題目風格可能不同。例如：
- 第一輪：初步筛選，可能更注重基本能力和語言表達
- 第二輪：深入評估，可能更注重邏輯思維和批判性思考
- 最终輪：综合評估，可能包含小組討論等

學生希望能够針對特定學校的特定輪次進行針對性練習，係統需要：
1. 存储和管理面試輪次信息
2. 根據學校和輪次搜索相關題目和面試回憶
3. 基于历史數據生成類似風格的模拟題目
4. 提供完整的模拟面試体验

## Goals / Non-Goals

### Goals
- 支持選擇學校和面試輪次進行模拟面試
- 基于该學校對应輪次的历史題目生成類似題目
- 在生成題目時能够搜索和參考學校輪次相關信息
- 提供完整的模拟面試流程，覆盖该輪次常见考查重點
- 保持与现有練習模式的兼容性

### Non-Goals
- 不强制要求所有面試回憶都必须有輪次信息（向後兼容）
- 不在本阶段实现多輪次面試的完整流程模拟（如第一輪通過後才能進入第二輪）
- 不实现面試官角色扮演的实時對話（已有AI模拟面試模式，但本功能專注于題目生成）

## Decisions

### Decision 1: 輪次信息存储方式

**方案A**: 在`interview_memories`表中增加`interview_round`字段
- 優點：简单直接，与现有數據結构一致
- 缺點：如果未來需要更复杂的輪次信息（如輪次描述、考查重點等），可能需要扩展

**方案B**: 創建独立的`interview_rounds`表，關聯到`interview_memories`
- 優點：更灵活，可以存储更多輪次相關信息
- 缺點：增加复杂度，当前需求可能不需要

**選擇**: 方案A。当前需求主要是根據輪次筛選和生成題目，在`interview_memories`表中增加可選字段即可满足需求。如果未來需要更复杂的輪次管理，可以再扩展。

### Decision 2: 輪次值的定义

**方案A**: 使用數字（"1", "2", "3"等）
- 優點：简单直觀
- 缺點：不同學校的輪次含义可能不同

**方案B**: 使用描述性字符串（"first-round", "second-round", "final-round"等）
- 優點：更清晰，可以包含更多信息
- 缺點：需要標準化，可能不够灵活

**方案C**: 使用中文描述（"第一輪", "第二輪", "最终輪"等）
- 優點：符合用户習惯
- 缺點：需要標準化，可能不够灵活

**選擇**: 方案B + 方案C結合。係統內部使用標準化英文值（"first-round", "second-round", "final-round"），前端显示使用中文。同時支持用户自定义輪次描述（如"SPCC第一輪"），存储在`interview_round`字段中。

### Decision 3: 題目生成策略

**方案A**: 仅從題庫中選擇该學校该輪次的现有題目
- 優點：简单，題目质量有保证
- 缺點：如果題目數量不足，可能无法完成完整模拟

**方案B**: 優先選擇现有題目，不足時AI生成類似題目
- 優點：保证題目數量，同時保持題目風格一致
- 缺點：需要AI生成邏輯，可能增加成本

**方案C**: 完全基于AI生成，參考历史題目風格
- 優點：灵活，可以生成任意數量的題目
- 缺點：完全依赖AI，可能風格不一致

**方案D**: 使用AI搜索外部信息，基于真实历史題目生成
- 優點：能够获取该學校真实考過的題目信息，更贴近实际
- 缺點：依赖AI的知識庫，可能搜索不到足够信息

**選擇**: 方案D（更新）。優先使用AI搜索外部信息（该學校历史考過的真实題目），基于搜索結果生成類似風格的模拟題目。如果外部搜索失敗，降级使用數據庫中的历史數據。这樣能够確保生成的題目更贴近该學校的真实面試情况。

### Decision 4: 題目信息來源和搜索策略

**主要信息來源**：
1. **外部AI搜索**（優先）：使用AI的知識庫搜索该學校历史真实考過的面試題目
   - 搜索该學校的历史面試題目
   - 搜索该學校不同輪次的考查重點
   - 搜索该學校的面試風格和特點
2. **數據庫历史數據**（降级）：如果外部搜索失敗，使用數據庫中的历史數據
   - `questions`表中`school_code`匹配的題目
   - `interview_memories`表中`school_code`和`interview_round`匹配的面試回憶

**搜索優先级**：
1. AI外部搜索（获取真实历史題目信息）
2. 數據庫中的历史題目和面試回憶（降级方案）
3. 基于學校特征生成（最後方案）

## Risks / Trade-offs

### Risk 1: 輪次數據不足
**風险**: 某些學校或輪次可能没有足够的历史數據
**缓解**: 
- 允许扩展到该學校的其他輪次數據
- 如果仍不足，使用该學校的一般特征生成題目
- 在UI中提示用户數據來源

### Risk 2: 輪次信息不準確
**風险**: 用户錄入的輪次信息可能不準確或不一致
**缓解**: 
- 提供標準化的輪次選項（下拉選擇）
- 允许用户自定义，但建議使用標準格式
- 在生成題目時，如果數據不足，自動扩展到更宽泛的范围

### Risk 3: AI生成題目風格不一致
**風险**: AI生成的題目可能与真实面試題目風格有差异
**缓解**: 
- 在提示詞中明確要求參考历史題目風格
- 提供历史題目作为示例
- 允许用户查看題目來源（历史題目 vs AI生成）

### Trade-off: 數據完整性 vs 功能可用性
- 如果嚴格要求輪次信息，可能導致功能无法使用（數據不足）
- 如果放宽要求，可能生成的題目不够針對性
- **平衡**: 優先使用精確匹配的數據，但允许降级到更宽泛的范围

## Migration Plan

### 數據庫迁移
1. 为`interview_memories`表增加`interview_round`字段（VARCHAR(50)，可選，允许NULL）
2. 增加索引：`INDEX idx_school_round (school_code, interview_round)`（如果MySQL支持）
3. 现有數據：`interview_round`字段为NULL，不影响现有功能

### 代碼迁移
1. 更新面試回憶錄入界面，增加輪次選擇
2. 更新面試回憶分析API，支持提取和保存輪次信息
3. 更新題目生成邏輯，支持基于輪次搜索和生成
4. 更新練習會話創建邏輯，支持學校-輪次模式

### 向後兼容
- 所有现有功能保持兼容
- 如果未選擇輪次或輪次信息不存在，降级到學校级別的題目生成
- 不影响现有的任務模式、自由模式和弱點專項練習模式

## Open Questions

1. **輪次標準化**: 是否需要定义標準的輪次列表（如"第一輪"、"第二輪"、"最终輪"），还是完全由用户自定义？
   - **建議**: 提供標準選項，同時允许自定义

2. **題目數量**: 一次模拟面試应该包含多少道題目？
   - **建議**: 可配置，默认10-15題，覆盖该輪次常见考查重點

3. **輪次信息展示**: 在題目生成時，是否需要向用户展示參考了哪些历史題目或面試回憶？
   - **建議**: 在題目详情中显示來源信息，但不在主流程中干扰用户

4. **多輪次支持**: 是否支持一次練習包含多个輪次（如先第一輪，再第二輪）？
   - **建議**: 第一阶段仅支持单輪次，未來可扩展
