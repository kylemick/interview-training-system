# Design: 語音输入功能技術设計

## Context

係統需要为練習页面的答案输入添加語音識別功能，支持中文、英文两種語言。**重要约束：不使用 Google 或 Apple 的語音識別服務**。DeepSeek API 本身不支持語音識別功能，需要使用 Vosk.js 進行本地离线識別。

## Goals / Non-Goals

### Goals
- 提供流畅的語音输入体验，支持实時語音转文字
- 支持中文（普通話）、英文两種語言識別
- 与现有文本输入功能无缝集成，用户可自由切换
- 提供清晰的錄音狀態反馈和错误处理
- **不使用 Google/Apple 語音識別服務**（隐私和數據安全考虑）
- 優先考虑本地离线識別方案（保护用户隐私）

### Non-Goals
- 不使用浏览器原生 Speech Recognition API（依赖 Google/Apple 服務）
- 不实现語音情感分析或語音质量評估（仅做转文字）
- 不实现語音回放功能（仅做输入，不做输出）

## Decisions

### Decision 1: 使用 Vosk 進行本地离线語音識別（推荐方案）

**選擇**: 使用 Vosk.js 進行本地离线語音識別

**理由**:
- **完全离线**：語音數據不离開用户设備，保护隐私
- **支持所需語言**：支持中文、英文两種語言（满足需求）
- **開源免费**：无需API調用成本
- **模型体积适中**：每種語言模型约50MB，两種語言共约100MB，可接受
- **準確率可接受**：经過訓練可達到中等以上準確率
- **符合隐私要求**：數據完全本地处理，不依赖第三方服務
- **DeepSeek不支持**：DeepSeek API 不支持語音转文字功能，无法使用

**技術实现**:
- 使用 Vosk.js（JavaScript包装器）
- 通過 WebAssembly 在浏览器中运行識別模型
- 使用 Web Audio API 進行音频采集
- 模型文件存储在本地，首次使用時下载

**替代方案**:
- **方案2：通過後端調用讯飞語音識別API**
  - 優點：識別準確率高，支持流式識別
  - 缺點：需要後端代理，增加係統复杂度，需要API密钥
  - 适用场景：對準確率要求极高，可以接受後端改動的场景
- **方案3：使用其他第三方服務（百度、Azure等）**
  - 需要後端代理，增加成本和复杂度
  - 不符合本地部署的隐私優先原則

### Decision 2: 前端組件化设計

**選擇**: 創建独立的 `VoiceInput` 組件，在 `Practice` 页面中集成

**理由**:
- 組件化设計便于复用和維护
- 封装語音識別邏輯，降低页面組件复杂度
- 便于单独测試和調試

**組件結构**:
```
components/
  └── VoiceInput.tsx          # 語音输入組件
      ├── 錄音控制（開始/停止）
      ├── 語言選擇器
      ├── 狀態显示（錄音中、識別中）
      └── 識別結果回調

utils/
  └── speechRecognition.ts    # 語音識別工具函數
      ├── 浏览器兼容性检测
      ├── API封装
      └── 错误处理
```

### Decision 3: 語言識別策略

**選擇**: 用户手動選擇識別語言，係統根據選擇设置API語言參數

**理由**:
- 三種語言差异较大（中文vs英文vs粤語），自動检测準確率低
- 用户明確知道要使用的語言，手動選擇更可靠
- 简化实现，避免复杂的語言检测邏輯

**語言映射**:
- 中文（普通話）: `zh-CN`
- 英文: `en-US` 或 `en-GB`

**替代方案**:
- 自動检测語言：準確率低，可能误識別
- 根據題目類別自動選擇：不够灵活，用户可能用不同語言回答

### Decision 4: 識別結果处理

**選擇**: 識別結果自動填充到文本输入框，支持手動编輯

**理由**:
- 保持与现有文本输入流程一致
- 允许用户修正識別错误
- 支持追加錄音（多次錄音結果合并）

**交互流程**:
1. 用户點击"語音输入"按钮
2. 選擇識別語言（首次使用或切换語言時）
3. 開始錄音，显示錄音狀態
4. 停止錄音，開始識別
5. 識別完成後，結果填充到输入框
6. 用户可继续编輯或再次錄音

### Decision 5: 浏览器兼容性和模型加载

**選擇**: 使用 Vosk.js，支持所有现代浏览器（通過 WebAssembly）

**理由**:
- Vosk.js 基于 WebAssembly，支持所有现代浏览器
- 不依赖浏览器原生API，兼容性更好
- 首次使用時需要下载語言模型（约50MB），後续可缓存

**模型加载策略**:
- 首次使用時提示用户下载語言模型
- 模型文件存储在浏览器 IndexedDB 中，避免重复下载
- 支持按需加载（用户選擇語言後再加载對应模型）
- 提供加载進度提示

**降级方案**:
- 如果 WebAssembly 不支持：隐藏語音输入按钮
- 如果模型加载失敗：提示用户使用文本输入
- 如果識別失敗：允许用户重試或切换回文本输入

## Risks / Trade-offs

### Risk 1: 模型体积和加载時間

**風险**: Vosk 語言模型约50MB，首次加载需要時間

**影响**: 首次使用体验可能较慢，需要等待模型下载

**缓解措施**:
- 提供加载進度提示
- 模型下载後缓存到 IndexedDB，後续无需重新下载
- 支持後台预加载（用户進入練習页面時開始加载）
- 提供"稍後使用"選項，允许用户先使用文本输入

### Risk 2: 識別準確率

**風险**: 本地識別準確率可能低于云端服務，特別是對于口音、噪音环境

**影响**: 識別結果可能需要更多手動修正

**缓解措施**:
- 提供手動编輯功能
- 支持多次錄音和追加內容
- 提供識別結果预览，用户確认後再填充
- 如果準確率不满足需求，可考虑切换到方案2（讯飞API）

### Risk 3: 識別準確率

**風险**: 語音識別可能出错，特別是口音、噪音、語速等因素影响

**影响**: 識別結果需要用户手動修正，降低效率

**缓解措施**:
- 提供手動编輯功能
- 支持多次錄音和追加內容
- 提供識別結果预览，用户確认後再提交

### Risk 3: WebAssembly 性能

**風险**: 在浏览器中运行語音識別模型可能消耗较多CPU和內存

**影响**: 可能影响页面性能，特別是在低端设備上

**缓解措施**:
- 優化模型加载，使用流式加载减少內存占用
- 提供性能监控，低端设備自動降级到文本输入
- 支持識別過程中暫停/恢复，避免長時間占用資源

### Risk 4: 模型更新和維护

**風险**: Vosk 模型需要定期更新以提升準確率

**影响**: 需要維护模型文件，更新可能影响用户体验

**缓解措施**:
- 模型版本管理，支持增量更新
- 提供模型更新提示（可選）
- 如果模型文件损坏，支持重新下载

## Implementation Details

### 組件API设計

```typescript
interface VoiceInputProps {
  onResult: (text: string) => void;  // 識別結果回調
  onError?: (error: Error) => void;  // 错误回調
  language?: 'zh-CN' | 'en-US';  // 識別語言（中文或英文）
  disabled?: boolean;  // 是否禁用
  onModelLoading?: (progress: number) => void;  // 模型加载進度回調
}

interface VoskConfig {
  modelPath: string;  // 模型文件路径（CDN或本地）
  language: string;  // 識別語言代碼
  sampleRate: number;  // 采樣率（默认16000）
}
```

### 狀態管理

```typescript
type VoiceInputState = 
  | 'idle'           // 空闲
  | 'listening'      // 錄音中
  | 'processing'     // 識別中
  | 'completed'      // 識別完成
  | 'error';         // 错误狀態
```

### 错误处理

- WebAssembly不支持: 隐藏組件，提示使用文本输入
- 模型加载失敗: 显示错误提示，允许重試或使用文本输入
- 麦克風权限拒绝: 提示用户允许麦克風权限
- 識別失敗: 显示错误提示，允许重試
- 內存不足: 提示用户關闭其他標籤页或使用文本输入

## Migration Plan

### 阶段1: 基础功能实现
1. 創建 `VoiceInput` 組件和工具函數
2. 在 `Practice` 页面集成語音输入
3. 实现基本的錄音和識別功能

### 阶段2: 用户体验優化
1. 添加語言選擇器
2. 優化狀態反馈和错误提示
3. 支持多次錄音和結果合并

### 阶段3: 兼容性和测試
1. 测試不同浏览器的兼容性
2. 处理边界情况和错误场景
3. 優化性能和用户体验

### 回滚方案
- 如果功能出现嚴重問題，可以通過配置開關禁用語音输入
- 保留文本输入作为主要输入方式，不影响核心功能

## Open Questions

1. **模型存储位置**: Vosk 模型文件存储在哪里？
   - **决策**: 
     - 開發环境：存储在 `public/models/` 目錄
     - 生产环境：使用 CDN 或本地服務器提供模型文件
     - 浏览器缓存：使用 IndexedDB 缓存已下载的模型

2. **語言支持**: 只需要中文和英文，不需要粤語支持
   - **决策**: 仅实现中文（zh-CN）和英文（en-US）两種語言的識別

3. **識別結果格式**: Vosk 是否自動添加標點符號？
   - **决策**: 
     - Vosk 默认不添加標點，需要後处理
     - 可以集成简单的標點符號添加邏輯（可選）
     - 或者依赖用户手動添加標點

4. **錄音時長限制**: 是否需要设置最大錄音時長？
   - **决策**: 
     - 不设置硬性限制，但建議用户分段錄音（每段不超過60秒）
     - 長時間錄音可能影响識別準確率和性能

5. **实時識別 vs 批量識別**: Vosk 支持流式識別还是批量識別？
   - **决策**: 
     - Vosk 支持流式識別，可以实時返回結果
     - 实现实時結果显示，提升用户体验

6. **備選方案**: 如果 Vosk 方案不满足需求，是否实现讯飞API方案？
   - **决策**: 
     - 先实现 Vosk 方案（本地离线，隐私優先）
     - 如果準確率或性能不满足需求，再考虑实现讯飞API方案作为備選
     - 两種方案可以通過配置切换
