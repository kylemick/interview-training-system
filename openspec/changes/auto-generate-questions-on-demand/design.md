# Design: 自動生成題目以避免服務中断

## Context

当前係統在多个场景下需要從題庫選擇題目：
1. 從訓練計劃任務启動練習會話（`POST /api/plans/tasks/:taskId/start-practice`）
2. 創建自由模式練習會話（`POST /api/sessions`）

当某个類別没有可用題目時，係統會抛出 `AppError(400, '该類別暫无可用題目,请先添加題目')`，導致流程中断。

## Goals / Non-Goals

### Goals
- 当检测到題目缺失時，自動調用AI生成題目
- 生成的題目數量应该满足当前需求（根據任務時長或指定數量計算）
- 生成的題目应该考虑上下文（類別、目標學校、難度）
- 確保错误处理不會導致服務崩溃或重启
- 保持现有API接口的兼容性

### Non-Goals
- 不改变題目生成API的接口
- 不改变題目數據結构
- 不改变前端交互流程（對用户透明）

## Decisions

### Decision 1: 自動生成題目的触發時机

**選擇**：在查询題目返回空結果時立即触發生成

**理由**：
- 時机明確：只有在真正需要題目時才生成，避免浪费
- 用户体验好：用户无需等待，係統自動处理
- 实现简单：在现有查询邏輯後添加生成邏輯即可

**替代方案**：
- 在創建計劃時预生成所有類別題目：浪费資源，可能生成不需要的題目
- 前端提示用户手動生成：增加用户操作步骤

### Decision 2: 題目生成數量策略

**選擇**：根據实际需求動態計算生成數量

**场景1 - 從任務启動練習**：
- 根據任務時長計算：`Math.max(1, Math.ceil(duration / 10))`，最少1題
- 如果前端指定了 `question_count`，使用前端值
- 生成數量 = `Math.max(calculatedCount, 3)`，至少生成3題以確保有足够選擇

**场景2 - 自由模式創建會話**：
- 使用前端指定的 `question_count`，默认10題
- 生成數量 = `Math.max(question_count, 3)`

**理由**：
- 避免频繁生成：一次生成足够數量，减少AI調用
- 保证可用性：至少生成3題，確保後续選擇有缓冲

### Decision 3: 題目生成參數

**選擇**：根據上下文智能设置生成參數

- **category**: 從任務或请求中获取
- **difficulty**: 默认使用 `medium`，後续可以根據學生表现調整
- **count**: 根據上述策略計算
- **school_code**: 從訓練計劃或任務關聯的計劃中获取目標學校
- **save**: 始终为 `true`，保存到數據庫

**理由**：
- 使用中等難度作为默认值，适合大多數學生
- 保存題目到數據庫，避免重复生成
- 考虑目標學校，生成更有針對性的題目

### Decision 4: AI生成失敗的处理

**選擇**：多层降级策略

1. **第一层**：如果AI生成失敗，記錄错误日志，但不抛出异常
2. **第二层**：尝試使用更简单的參數重新生成（减少數量、不指定學校）
3. **第三层**：如果仍然失敗，返回友好的错误信息，但不導致服務崩溃

**理由**：
- 確保服務稳定性：即使AI失敗，也不应该導致整个服務崩溃
- 提供降级方案：尝試简化參數可能成功
- 用户友好：清晰的错误信息帮助用户理解問題

### Decision 5: 错误处理增强

**選擇**：在所有可能抛出題目缺失错误的地方，改为自動生成

**需要修改的位置**：
1. `backend/src/routes/plans.ts:738` - 现有會話中題目被删除的情况
2. `backend/src/routes/plans.ts:784` - 新會話創建時没有題目
3. `backend/src/routes/sessions.ts:41` - 自由模式創建會話時没有題目

**理由**：
- 統一处理：所有场景都使用相同的自動生成邏輯
- 减少代碼重复：提取为公共函數
- 確保完整性：不遗漏任何可能的問題點

## Risks / Trade-offs

### Risk 1: AI生成延迟影响用户体验
**風险**：AI生成題目可能需要几秒鐘，用户需要等待
**缓解**：
- 显示加载提示（前端已有loading狀態）
- 异步生成：可以先返回部分結果，後台继续生成
- 考虑缓存：相同參數的題目可以复用

### Risk 2: AI生成成本增加
**風险**：频繁自動生成可能增加API調用成本
**缓解**：
- 生成的題目保存到數據庫，避免重复生成
- 生成數量合理控制，不過度生成
- 優先使用现有題目，只在必要時生成

### Risk 3: 生成的題目质量不一致
**風险**：自動生成的題目可能质量參差不齐
**缓解**：
- 使用现有的AI生成邏輯，已经過验证
- 生成的題目可以後续人工审核和優化
- 係統會記錄題目來源，便于追踪

## Migration Plan

### 步骤1：創建題目自動生成辅助函數
- 在 `backend/src/routes/plans.ts` 或新建工具文件
- 函數籤名：`async function ensureQuestionsAvailable(category, count, schoolCode?, difficulty?)`
- 邏輯：查询題目 → 如果不足則生成 → 返回題目列表

### 步骤2：修改訓練計劃任務启動邏輯
- 在 `POST /api/plans/tasks/:taskId/start-practice` 中
- 替换抛出错误为調用 `ensureQuestionsAvailable`
- 处理AI生成失敗的情况

### 步骤3：修改自由模式會話創建邏輯
- 在 `POST /api/sessions` 中
- 替换抛出错误为調用 `ensureQuestionsAvailable`
- 处理AI生成失敗的情况

### 步骤4：增强错误处理
- 確保所有错误都被正確捕获
- 验证错误处理不會導致服務重启
- 添加适当的日志記錄

### 步骤5：测試验证
- 测試題目缺失场景
- 测試AI生成失敗场景
- 测試正常流程不受影响

## Open Questions

1. **題目生成數量**：是否应该生成更多題目作为缓冲？当前策略是至少生成3題，是否足够？
   - **决定**：至少生成所需數量+2題作为缓冲，但不超過10題

2. **難度選擇**：是否应该根據學生历史表现動態選擇難度？
   - **决定**：当前使用 `medium` 作为默认值，後续可以增强

3. **生成频率限制**：是否应该限制同一類別的生成频率？
   - **决定**：暫不限制，因为題目會保存到數據庫，重复生成的情况较少
