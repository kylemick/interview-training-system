# 性能優化文檔

## 性能目標

### 前端性能

- **页面首次加载時間**：< 1 秒（本地环境）
- **页面刷新**：所有页面刷新後能正常加载數據
- **交互响应時間**：< 100ms

### 後端性能

- **API 响应時間**：
  - 简单查询（单表查询）：< 500ms
  - 复杂查询（多表 JOIN、統計）：< 2 秒
- **數據庫查询**：
  - 慢查询阈值：100ms
  - 所有超過阈值的查询都會記錄日志

## 已实施的優化

### 前端優化

1. **API 请求優化**
   - ✅ 并行请求：使用 `Promise.all` 并行加载數據
   - ✅ 请求去重：相同请求在 pending 時不重复發送
   - ✅ 请求缓存：GET 请求缓存 5 分鐘
   - ✅ 请求取消：組件卸载時自動取消未完成的请求
   - ✅ 超時设置：API 超時從 30 秒降低到 10 秒

2. **React 性能優化**
   - ✅ 使用 `useMemo` 缓存計算結果
   - ✅ 使用 `useCallback` 缓存回調函數
   - ✅ 使用 `React.memo` 優化列表組件（如需要）
   - ✅ 優化 columns 定义，避免每次渲染重新創建

3. **页面優化**
   - ✅ Dashboard 页面：并行加载任務、會話、弱點數據
   - ✅ Questions 页面：并行加载題目、統計、學校列表

### 後端優化

1. **數據庫查询優化**
   - ✅ 查询性能监控：記錄超過 100ms 的慢查询
   - ✅ 查询結果缓存：學校列表、統計信息等使用缓存（5 分鐘 TTL）
   - ✅ JSON 字段統一解析：在數據庫访問层統一解析，避免重复解析
   - ✅ 數據庫索引：已为所有常用查询字段添加索引

2. **路由優化**
   - ✅ 學校列表：使用缓存
   - ✅ 統計查询：使用缓存
   - ✅ JSON 字段解析：統一使用 `parseJsonField` 函數

## 性能监控

### 前端监控

- 使用浏览器開發者工具 Network 面板监控 API 请求時間
- 使用 React DevTools Profiler 分析組件渲染性能

### 後端监控

- 慢查询日志：所有超過 100ms 的查询都會在控制台输出警告
- 查询統計：開發环境下記錄所有查询的 SQL 和參數

## 性能测試方法

### 前端性能测試

1. **页面加载時間**
   ```bash
   # 使用浏览器開發者工具
   # 1. 打開 Network 面板
   # 2. 刷新页面
   # 3. 查看 Load 時間（应 < 1 秒）
   ```

2. **API 响应時間**
   ```bash
   # 使用 curl 测試
   curl -w "@curl-format.txt" -o /dev/null -s "http://localhost:3001/api/schools"
   ```

### 後端性能测試

1. **數據庫查询性能**
   ```bash
   # 查看慢查询日志（開發环境下自動输出）
   # 所有超過 100ms 的查询都會显示警告
   ```

2. **API 响应時間**
   ```bash
   # 使用 curl 测試
   time curl "http://localhost:3001/api/questions?limit=10"
   ```

## 性能優化建議

### 前端

1. **图片優化**
   - 使用适当的图片格式（WebP、AVIF）
   - 实现图片懒加载

2. **代碼分割**
   - 使用 React.lazy 实现路由级別的代碼分割
   - 使用動態 import 实现組件级別的代碼分割

3. **缓存策略**
   - 静態資源使用長期缓存
   - API 响应使用短期缓存（5 分鐘）

### 後端

1. **數據庫優化**
   - 定期分析慢查询日志
   - 根據查询模式調整索引
   - 考虑使用物化视图（如需要）

2. **缓存策略**
   - 對频繁访問的數據使用缓存
   - 实现缓存失效策略（數據变更時清除相關缓存）

3. **查询優化**
   - 避免 SELECT *
   - 使用 LIMIT 限制結果數量
   - 避免 N+1 查询問題

## 性能問題排查

### 页面加载慢

1. 检查 Network 面板，找出慢的 API 请求
2. 检查是否有重复请求
3. 检查是否有阻塞渲染的操作

### API 响应慢

1. 查看後端慢查询日志
2. 检查數據庫查询是否使用了索引
3. 检查是否有 N+1 查询問題

### 页面刷新失敗

1. 检查 API 请求是否成功
2. 检查错误处理是否正確
3. 检查組件狀態管理是否正確

## 參考資源

- [Web Performance](https://web.dev/performance/)
- [React Performance](https://react.dev/learn/render-and-commit)
- [MySQL Performance Tuning](https://dev.mysql.com/doc/refman/8.0/en/optimization.html)
