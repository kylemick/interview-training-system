## ADDED Requirements

### Requirement: 按需自动生成题目
系统SHALL在检测到题目缺失时自动生成题目，确保流程不中断。

#### Scenario: 检测题目不足并自动生成
- **WHEN** 系统需要为某个类别选择题目
- **AND** 查询发现该类别没有可用题目或数量不足
- **THEN** 系统自动调用AI生成题目功能
- **AND** 生成数量根据实际需求计算（至少3题，最多不超过所需数量的2倍）
- **AND** 生成的题目立即保存到数据库，标注来源为"ai_generated"
- **AND** 生成完成后继续原有流程，对用户透明

#### Scenario: 智能生成参数设置
- **WHEN** 系统自动生成题目时
- **THEN** 根据上下文设置生成参数：
  - category: 从任务或请求中获取
  - difficulty: 默认使用"medium"，后续可根据学生表现调整
  - count: 根据实际需求计算，至少3题
  - school_code: 如果有关联的训练计划，使用计划的目标学校
  - save: 始终为true，保存到数据库
- **AND** 生成的题目符合类别语言规范（如english-oral使用英文）

#### Scenario: AI生成失败时的降级处理
- **WHEN** 系统尝试自动生成题目
- **AND** AI API调用失败（网络错误、API限制、格式错误等）
- **THEN** 系统记录错误日志，但不抛出异常导致服务崩溃
- **AND** 尝试使用简化参数重新生成（减少数量、不指定学校）
- **AND** 如果仍然失败，返回友好的错误信息给用户
- **AND** 错误信息说明题目生成失败，建议用户稍后重试或手动生成题目
- **AND** 服务继续运行，不影响其他功能

## MODIFIED Requirements

### Requirement: AI生成题目
系统SHALL使用AI生成题目以扩充题库，支持按需自动生成。

#### Scenario: 按需自动生成题目
- **WHEN** 系统检测到题目缺失需要自动生成
- **THEN** 调用现有的AI生成题目功能
- **AND** 使用上下文信息（类别、目标学校、难度）生成合适的题目
- **AND** 生成的题目立即保存到数据库
- **AND** 返回生成的题目列表供后续使用
- **AND** 如果生成失败，提供降级处理，不中断服务
