# Change: 計劃和練習聯動

## Why

当前係統中,訓練計劃和練習會話是完全独立的两个模块。用户創建了訓練計劃後,仍然需要手動選擇類別和數量來開始練習,无法跟随計劃進行係統化訓練。这導致:
1. 計劃失去了指導作用,用户可能偏离計劃随意練習
2. 每日任務的完成狀態无法与实际練習會話同步
3. 用户体验不连贯,需要在两个模块之間手動协調
4. 无法追踪用户是否按計劃完成訓練,影响進度統計和反馈质量

## What Changes

### 核心功能
- 在前端Dashboard和訓練計劃页面,增加"開始今日任務"入口,直接進入對应的練習會話
- 練習會話与每日任務强關聯,創建會話時自動從任務指定的類別選擇題目
- 完成練習會話後,自動標記關聯的每日任務为已完成
- 在練習页面显示当前任務來源(計劃名称、日期、類別、進度)
- 提供"自由練習"模式,允许用户不跟随計劃進行额外練習

### 用户体验增强
- 任務完成後智能引導: 提示继续下一个任務或庆祝全部完成
- 任務狀態可视化: 清晰展示待開始/進行中/已完成三種狀態
- 双模式支持: 任務練習(計劃驱動)和自由練習(灵活選擇)并存

### 技術实现
- 新增API: `GET /api/plans/pending-tasks` (获取未完成任務)
- 新增API: `POST /api/plans/tasks/:taskId/start-practice` (從任務創建會話)
- 增强API: `PATCH /api/sessions/:id/complete` (自動同步任務狀態)
- 數據庫: 增强`sessions.task_id`外键關聯,添加索引優化查询

**BREAKING**: 練習會話創建邏輯改变,需要检查是否有未完成的計劃任務。但保持向後兼容,自由練習模式不受影响。

## Impact

### 影响規范
- **practice-linkage** (新增): 定义任務-會話聯動机制和双模式支持

### 影响代碼
- **前端**:
  - `Practice/index.tsx`: 支持taskId參數,任務模式自動加载,任務信息横幅显示
  - `Dashboard/index.tsx`: 今日任務卡片,任務進度展示,一键启動練習
  - `TrainingPlan/index.tsx`: 任務狀態显示,開始按钮,任務列表優化
- **後端**:
  - `routes/sessions.ts`: 完成會話時自動標記關聯任務完成
  - `routes/plans.ts`: 新增pending-tasks和start-practice接口
- **數據庫**:
  - `sessions`表: 增强`task_id`外键约束和索引
  - `daily_tasks`表: 添加狀態索引優化查询

### 实现狀態
- ✅ **已完成**: 核心功能已实现并测試通過
  - 任務驱動的練習入口
  - 會話-任務自動關聯和狀態同步
  - 双模式支持(任務練習/自由練習)
  - 任務完成後的流程引導
- 🔄 **進行中**: 部分增强功能
  - 任務跳過功能
  - 導航栏任務徽章
  - 統計數據区分
- 📋 **待規劃**: 未來優化方向
  - 任務恢复功能(暫停後继续)
  - 任務历史页面
  - 更详细的進度追踪

## Benefits

1. **用户体验提升**: 從"創建計劃→手動選擇練習"变为"一键開始任務",操作步骤减少60%
2. **數據一致性**: 任務狀態与練習會話自動同步,避免手動更新错误
3. **訓練效果**: 用户更可能按計劃完成訓練,提高係統化訓練效果
4. **灵活性**: 保留自由練習模式,不强制用户必须創建計劃
5. **可扩展性**: 为後续功能(任務恢复、進度分析等)打下基础
